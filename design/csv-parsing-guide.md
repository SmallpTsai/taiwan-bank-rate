# 台灣銀行匯率 CSV 解析指南

## CSV 格式分析

### 即時匯率 CSV 格式

**URL**: `https://rate.bot.com.tw/xrt/flcsv/0/day`

**標題行**:
```
幣別,匯率,現金,即期,遠期10天,遠期30天,遠期60天,遠期90天,遠期120天,遠期150天,遠期180天,匯率,現金,即期,遠期10天,遠期30天,遠期60天,遠期90天,遠期120天,遠期150天,遠期180天
```

**資料行範例**:
```
USD,本行買入,29.61500,29.94000,29.94500,29.88500,29.80500,29.73500,29.66400,29.59000,29.52300,本行賣出,30.28500,30.09000,30.04900,29.99600,29.92600,29.86500,29.80400,29.74000,29.68300,
```

**欄位索引對照表**:

| 索引 | 欄位名稱 | 範例值 | 說明 |
|------|----------|--------|------|
| 0 | 幣別 | USD | 幣別代碼 |
| 1 | 買入標籤 | 本行買入 | 固定文字 |
| 2 | 現金買入 | 29.61500 | **現金買入匯率** |
| 3 | 即期買入 | 29.94000 | **即期買入匯率** |
| 4 | 遠期10天買入 | 29.94500 | 遠期10天買入匯率 |
| 5 | 遠期30天買入 | 29.88500 | 遠期30天買入匯率 |
| 6 | 遠期60天買入 | 29.80500 | 遠期60天買入匯率 |
| 7 | 遠期90天買入 | 29.73500 | 遠期90天買入匯率 |
| 8 | 遠期120天買入 | 29.66400 | 遠期120天買入匯率 |
| 9 | 遠期150天買入 | 29.59000 | 遠期150天買入匯率 |
| 10 | 遠期180天買入 | 29.52300 | 遠期180天買入匯率 |
| 11 | 賣出標籤 | 本行賣出 | 固定文字 |
| 12 | 現金賣出 | 30.28500 | **現金賣出匯率** |
| 13 | 即期賣出 | 30.09000 | **即期賣出匯率** |
| 14 | 遠期10天賣出 | 30.04900 | 遠期10天賣出匯率 |
| 15 | 遠期30天賣出 | 29.99600 | 遠期30天賣出匯率 |
| 16 | 遠期60天賣出 | 29.92600 | 遠期60天賣出匯率 |
| 17 | 遠期90天賣出 | 29.86500 | 遠期90天賣出匯率 |
| 18 | 遠期120天賣出 | 29.80400 | 遠期120天賣出匯率 |
| 19 | 遠期150天賣出 | 29.74000 | 遠期150天賣出匯率 |
| 20 | 遠期180天賣出 | 29.68300 | 遠期180天賣出匯率 |

### 歷史匯率 CSV 格式

**URL**: `https://rate.bot.com.tw/xrt/flcsv/0/[YYYY-MM]/[Currency]`

**標題行**:
```
資料日期,幣別,匯率,現金,即期,遠期10天,遠期30天,遠期60天,遠期90天,遠期120天,遠期150天,遠期180天,匯率,現金,即期,遠期10天,遠期30天,遠期60天,遠期90天,遠期120天,遠期150天,遠期180天
```

**資料行範例**:
```
20250731,USD,本行買入,29.47000,29.82000,29.80000,29.74000,29.65800,29.58800,29.51900,29.44400,29.37600,本行賣出,30.14000,29.92000,29.90500,29.85000,29.77800,29.71800,29.65900,29.59400,29.53400,
```

**欄位索引對照表**:

| 索引 | 欄位名稱 | 範例值 | 說明 |
|------|----------|--------|------|
| 0 | 資料日期 | 20250731 | 日期 (YYYYMMDD 格式) |
| 1 | 幣別 | USD | 幣別代碼 |
| 2 | 買入標籤 | 本行買入 | 固定文字 |
| 3 | 現金買入 | 29.47000 | **現金買入匯率** |
| 4 | 即期買入 | 29.82000 | **即期買入匯率** |
| 5 | 遠期10天買入 | 29.80000 | 遠期10天買入匯率 |
| 6 | 遠期30天買入 | 29.74000 | 遠期30天買入匯率 |
| 7 | 遠期60天買入 | 29.65800 | 遠期60天買入匯率 |
| 8 | 遠期90天買入 | 29.58800 | 遠期90天買入匯率 |
| 9 | 遠期120天買入 | 29.51900 | 遠期120天買入匯率 |
| 10 | 遠期150天買入 | 29.44400 | 遠期150天買入匯率 |
| 11 | 遠期180天買入 | 29.37600 | 遠期180天買入匯率 |
| 12 | 賣出標籤 | 本行賣出 | 固定文字 |
| 13 | 現金賣出 | 30.14000 | **現金賣出匯率** |
| 14 | 即期賣出 | 29.92000 | **即期賣出匯率** |
| 15 | 遠期10天賣出 | 29.90500 | 遠期10天賣出匯率 |
| 16 | 遠期30天賣出 | 29.85000 | 遠期30天賣出匯率 |
| 17 | 遠期60天賣出 | 29.77800 | 遠期60天賣出匯率 |
| 18 | 遠期90天賣出 | 29.71800 | 遠期90天賣出匯率 |
| 19 | 遠期120天賣出 | 29.65900 | 遠期120天賣出匯率 |
| 20 | 遠期150天賣出 | 29.59400 | 遠期150天賣出匯率 |
| 21 | 遠期180天賣出 | 29.53400 | 遠期180天賣出匯率 |

## 正確的解析邏輯

### 即時匯率解析

```typescript
private parseRateLine(line: string[]): RateData | null {
  try {
    return {
      currency: line[0],           // 幣別
      cashBuy: parseFloat(line[2]), // 現金買入 (索引 2)
      cashSell: parseFloat(line[12]), // 現金賣出 (索引 12)
      spotBuy: parseFloat(line[3]), // 即期買入 (索引 3)
      spotSell: parseFloat(line[13]), // 即期賣出 (索引 13)
      timestamp: new Date()
    };
  } catch (error) {
    return null;
  }
}
```

### 歷史匯率解析

```typescript
private parseHistoricalRateLine(line: string[]): HistoricalRateData | null {
  try {
    // 歷史匯率格式：日期,幣別,匯率,現金,即期,遠期...,匯率,現金,即期,遠期...
    // 需要調整索引以匹配即時匯率格式
    const adjustedLine = [
      line[1],  // 幣別
      line[2],  // "本行買入"
      line[3],  // 現金買入
      line[4],  // 即期買入
      line[5],  // 遠期10天買入
      line[6],  // 遠期30天買入
      line[7],  // 遠期60天買入
      line[8],  // 遠期90天買入
      line[9],  // 遠期120天買入
      line[10], // 遠期150天買入
      line[11], // 遠期180天買入
      line[12], // "本行賣出"
      line[13], // 現金賣出
      line[14], // 即期賣出
      line[15], // 遠期10天賣出
      line[16], // 遠期30天賣出
      line[17], // 遠期60天賣出
      line[18], // 遠期90天賣出
      line[19], // 遠期120天賣出
      line[20], // 遠期150天賣出
      line[21]  // 遠期180天賣出
    ];
    
    const rateData = this.parseRateLine(adjustedLine);
    if (!rateData) return null;

    return {
      ...rateData,
      date: line[0] // 日期
    };
  } catch (error) {
    return null;
  }
}
```

## 驗證要點

1. **欄位數量驗證**:
   - 即時匯率：每行應有 21 個欄位
   - 歷史匯率：每行應有 22 個欄位

2. **關鍵欄位驗證**:
   - 索引 1 和 11 應為 "本行買入" 和 "本行賣出"
   - 索引 2, 3, 12, 13 應為有效的數字

3. **錯誤處理**:
   - 解析失敗時返回 null
   - 跳過無效的資料行
   - 記錄解析錯誤以便除錯

## 測試案例

### 即時匯率測試
```typescript
const csvLine = "USD,本行買入,29.61500,29.94000,29.94500,29.88500,29.80500,29.73500,29.66400,29.59000,29.52300,本行賣出,30.28500,30.09000,30.04900,29.99600,29.92600,29.86500,29.80400,29.74000,29.68300,";
const result = parseRateLine(csvLine.split(','));
// 預期結果：
// {
//   currency: "USD",
//   cashBuy: 29.61500,
//   cashSell: 30.28500,
//   spotBuy: 29.94000,
//   spotSell: 30.09000
// }
```

### 歷史匯率測試
```typescript
const csvLine = "20250731,USD,本行買入,29.47000,29.82000,29.80000,29.74000,29.65800,29.58800,29.51900,29.44400,29.37600,本行賣出,30.14000,29.92000,29.90500,29.85000,29.77800,29.71800,29.65900,29.59400,29.53400,";
const result = parseHistoricalRateLine(csvLine.split(','));
// 預期結果：
// {
//   currency: "USD",
//   cashBuy: 29.47000,
//   cashSell: 30.14000,
//   spotBuy: 29.82000,
//   spotSell: 29.92000,
//   date: "20250731"
// }
``` 